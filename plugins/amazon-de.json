{
  "$schema": "https://raw.githubusercontent.com/invoice-snatcher/plugins/main/schema.json",
  "id": "amazon-de",
  "name": "Amazon DE",
  "description": "Get invoices from Amazon.de.",
  "homepage": "https://amazon.de",
  "configSchema": {},
  "checkAuth": [
    {
      "action": "navigate",
      "url": "https://www.amazon.de/gp/css/order-history"
    },
    {
      "action": "checkElementExists",
      "selector": "[data-nav-ref*='account_btn']"
    }
  ],
  "startAuth": [
    {
      "action": "navigate",
      "url": "https://www.amazon.de/ap/signin?openid.mode=checkid_setup&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0&openid.return_to=https%3A%2F%2Fwww.amazon.de%2Fref%3Drhf_sign_in&openid.assoc_handle=deflex&openid.pape.max_auth_age=0"
    },
    {
      "action": "waitForElement",
      "selector": "[data-nav-ref*='account_btn']",
      "timeout": 120000
    }
  ],
  "getInvoices": [
    {
      "action": "navigate",
      "url": "https://www.amazon.de/gp/css/order-history"
    },
    {
      "action": "waitForElement",
      "selector": ".order-card,.order"
    },
    {
      "action": "extractAll",
      "selector": ".order-card,.order",
      "variable": "order",
      "fields": {
        "url": {
          "selector": "a[href*='invoice.html']",
          "attribute": "href"
        },
        "id": {
          "selector": ".yohtmlc-order-id span:last-of-type"
        },
        "date": {
          "selector": ".a-col-left .a-column:nth-child(1) .a-size-base"
        },
        "price": {
          "selector": ".a-col-left .a-column:last-of-type .a-size-base"
        }
      },
      "pagination": {
        "type": "next",
        "selector": ".a-pagination li:last-of-type:not(.a-disabled)",
        "waitForSelector": ".order-card,.order"
      },
      "forEach": [
        {
          "action": "navigate",
          "url": "{{ order.url }}"
        },
        {
          "action": "extractAll",
          "selector": "li:has(a[href$='.pdf'])",
          "variable": "invoice",
          "fields": {
            "url": {
              "selector": "a",
              "attribute": "href"
            }
          },
          "forEach": [
            {
              "action": "downloadPdf",
              "url": "{{ invoice.url }}",
              "invoice": {
                "id": "{{order.id}}",
                "date": "{{order.date}}",
                "total": "{{order.price}}"
              }
            }
          ]
        }
      ]
    }
  ]
}
